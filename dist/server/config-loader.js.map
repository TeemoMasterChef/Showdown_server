{
  "version": 3,
  "sources": ["../../server/config-loader.ts"],
  "sourcesContent": ["/**\r\n * Config loader\r\n * Pokemon Showdown - http://pokemonshowdown.com/\r\n *\r\n * @license MIT\r\n */\r\n\r\nimport * as defaults from '../config/config-example';\r\nimport type { GroupInfo, EffectiveGroupSymbol } from './user-groups';\r\nimport { ProcessManager, FS } from '../lib';\r\n\r\ntype DefaultConfig = typeof defaults;\r\n\r\ntype InputConfig = Omit<DefaultConfig, 'subprocesses'> & {\r\n\tsubprocesses: null | 0 | 1 | SubProcessesConfig,\r\n};\r\n\r\ntype ProcessType = (\r\n\t'localartemis' | 'remoteartemis' | 'battlesearch' | 'datasearch' | 'friends' |\r\n\t'chatdb' | 'pm' | 'modlog' | 'network' | 'simulator' | 'validator' | 'verifier'\r\n);\r\n\r\ntype SubProcessesConfig = Partial<Record<ProcessType, number>>;\r\n\r\nexport type ConfigType = InputConfig & {\r\n\tgroups: { [symbol: string]: GroupInfo },\r\n\tgroupsranking: EffectiveGroupSymbol[],\r\n\tgreatergroupscache: { [combo: string]: GroupSymbol },\r\n\tsubprocessescache: SubProcessesConfig,\r\n\t[k: string]: any,\r\n};\r\n/** Map<process flag, config settings for it to turn on> */\r\nconst FLAG_PRESETS = new Map([\r\n\t['--no-security', ['nothrottle', 'noguestsecurity', 'noipchecks']],\r\n]);\r\n\r\nconst processTypes: ProcessType[] = [\r\n\t'localartemis', 'remoteartemis', 'battlesearch', 'datasearch', 'friends',\r\n\t'chatdb', 'pm', 'modlog', 'network', 'simulator', 'validator', 'verifier',\r\n];\r\n\r\nconst CONFIG_PATH = FS('./config/config.js').path;\r\n\r\nexport function load(invalidate = false) {\r\n\tif (invalidate) delete require.cache[CONFIG_PATH];\r\n\tconst config = ({ ...defaults, ...require(CONFIG_PATH) }) as ConfigType;\r\n\t// config.routes is nested - we need to ensure values are set for its keys as well.\r\n\tconfig.routes = { ...defaults.routes, ...config.routes };\r\n\r\n\tif (!process.send) {\r\n\t\t// Automatically stop startup if optional dependencies are enabled yet missing\r\n\t\tif (config.usesqlite) {\r\n\t\t\ttry {\r\n\t\t\t\trequire.resolve('better-sqlite3');\r\n\t\t\t} catch {\r\n\t\t\t\tthrow new Error(`better-sqlite3 is not installed or could not be loaded, but Config.usesqlite is enabled.`);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (config.ofemain) {\r\n\t\t\ttry {\r\n\t\t\t\trequire.resolve('node-oom-heapdump');\r\n\t\t\t} catch {\r\n\t\t\t\tthrow new Error(\r\n\t\t\t\t\t`node-oom-heapdump is not installed, but it is a required dependency if Config.ofemain is set to true! ` +\r\n\t\t\t\t\t`Run npm install node-oom-heapdump and restart the server.`\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfor (const [preset, values] of FLAG_PRESETS) {\r\n\t\tif (process.argv.includes(preset)) {\r\n\t\t\tfor (const value of values) config[value] = true;\r\n\t\t}\r\n\t}\r\n\r\n\tcacheSubProcesses(config);\r\n\tcacheGroupData(config);\r\n\treturn config;\r\n}\r\n\r\nfunction cacheSubProcesses(config: ConfigType) {\r\n\tif (config.subprocesses !== undefined) {\r\n\t\t// Leniently accept all other falsy values, including `null`.\r\n\t\tconst value = config.subprocesses || 0;\r\n\t\tif (value === 0 || value === 1) {\r\n\t\t\t// https://github.com/microsoft/TypeScript/issues/35745\r\n\t\t\tconfig.subprocessescache = (Object.fromEntries(\r\n\t\t\t\tprocessTypes.map(k => [k, value])\r\n\t\t\t) as Record<ProcessType, number>);\r\n\t\t} else if (typeof value === 'object') {\r\n\t\t\tconfig.subprocessescache = value;\r\n\t\t} else {\r\n\t\t\treportError(`Invalid \\`subprocesses\\` specification. Use any of 0, 1, or a plain old object.`);\r\n\t\t}\r\n\t}\r\n\tconfig.subprocessescache ??= {};\r\n\tconst deprecatedKeys = [];\r\n\tif ('workers' in config) {\r\n\t\tdeprecatedKeys.push('workers');\r\n\t\tconfig.subprocessescache.network = config.workers;\r\n\t}\r\n\tfor (const processType of processTypes) {\r\n\t\tif (processType === 'network') continue;\r\n\t\tconst compatKey = `${processType}processes`;\r\n\t\tif (compatKey in config) {\r\n\t\t\tdeprecatedKeys.push(compatKey);\r\n\t\t\tconfig.subprocessescache[processType] = config[compatKey];\r\n\t\t}\r\n\t}\r\n\tfor (const compatKey of deprecatedKeys) {\r\n\t\treportError(\r\n\t\t\t`You are using \\`${compatKey}\\`, which is deprecated\\n` +\r\n\t\t\t`Support for this may be removed.\\n` +\r\n\t\t\t`Please ensure that you update your config.js to use \\`subprocesses\\` (see config-example.js, line 80).\\n`\r\n\t\t);\r\n\t}\r\n}\r\n\r\nexport function cacheGroupData(config: ConfigType) {\r\n\tif (config.groups) {\r\n\t\t// Support for old config groups format.\r\n\t\t// Should be removed soon.\r\n\t\treportError(\r\n\t\t\t`You are using a deprecated version of user group specification in config.\\n` +\r\n\t\t\t`Support for this may be removed.\\n` +\r\n\t\t\t`Please ensure that you update your config.js to the new format (see config-example.js, line 521).\\n`\r\n\t\t);\r\n\t} else {\r\n\t\tconfig.punishgroups = Object.create(null);\r\n\t\tconfig.groups = Object.create(null);\r\n\t\tconfig.groupsranking = [];\r\n\t\tconfig.greatergroupscache = Object.create(null);\r\n\t}\r\n\r\n\tconst groups = config.groups;\r\n\tconst punishgroups = config.punishgroups;\r\n\tconst cachedGroups: { [k: string]: 'processing' | true } = {};\r\n\r\n\tfunction isPermission(key: string) {\r\n\t\treturn !['symbol', 'id', 'name', 'rank', 'globalGroupInPersonalRoom'].includes(key);\r\n\t}\r\n\tfunction cacheGroup(symbol: string, groupData: GroupInfo) {\r\n\t\tif (cachedGroups[symbol] === 'processing') {\r\n\t\t\tthrow new Error(`Cyclic inheritance in group config for symbol \"${symbol}\"`);\r\n\t\t}\r\n\t\tif (cachedGroups[symbol] === true) return;\r\n\r\n\t\tfor (const key in groupData) {\r\n\t\t\tif (isPermission(key)) {\r\n\t\t\t\tconst jurisdiction = groupData[key as 'jurisdiction'];\r\n\t\t\t\tif (typeof jurisdiction === 'string' && jurisdiction.includes('s')) {\r\n\t\t\t\t\treportError(`Outdated jurisdiction for permission \"${key}\" of group \"${symbol}\": 's' is no longer a supported jurisdiction; we now use 'ipself' and 'altsself'`);\r\n\t\t\t\t\tdelete groupData[key as 'jurisdiction'];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (groupData['inherit']) {\r\n\t\t\tcachedGroups[symbol] = 'processing';\r\n\t\t\tconst inheritGroup = groups[groupData['inherit']];\r\n\t\t\tcacheGroup(groupData['inherit'], inheritGroup);\r\n\t\t\t// Add lower group permissions to higher ranked groups,\r\n\t\t\t// preserving permissions specifically declared for the higher group.\r\n\t\t\tfor (const key in inheritGroup) {\r\n\t\t\t\tif (key in groupData) continue;\r\n\t\t\t\tif (!isPermission(key)) continue;\r\n\t\t\t\t(groupData as any)[key] = (inheritGroup as any)[key];\r\n\t\t\t}\r\n\t\t\tdelete groupData['inherit'];\r\n\t\t}\r\n\t\tcachedGroups[symbol] = true;\r\n\t}\r\n\r\n\tif (config.grouplist) { // Using new groups format.\r\n\t\tconst grouplist = config.grouplist as any;\r\n\t\tconst numGroups = grouplist.length;\r\n\t\tfor (let i = 0; i < numGroups; i++) {\r\n\t\t\tconst groupData = grouplist[i];\r\n\r\n\t\t\t// punish groups\r\n\t\t\tif (groupData.punishgroup) {\r\n\t\t\t\tpunishgroups[groupData.id] = groupData;\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tgroupData.rank = numGroups - i - 1;\r\n\t\t\tgroups[groupData.symbol] = groupData;\r\n\t\t\tconfig.groupsranking.unshift(groupData.symbol);\r\n\t\t}\r\n\t}\r\n\r\n\tfor (const sym in groups) {\r\n\t\tconst groupData = groups[sym];\r\n\t\tcacheGroup(sym, groupData);\r\n\t}\r\n\r\n\t// hardcode default punishgroups.\r\n\tif (!punishgroups.locked) {\r\n\t\tpunishgroups.locked = {\r\n\t\t\tname: 'Locked',\r\n\t\t\tid: 'locked',\r\n\t\t\tsymbol: '\\u203d',\r\n\t\t};\r\n\t}\r\n\tif (!punishgroups.muted) {\r\n\t\tpunishgroups.muted = {\r\n\t\t\tname: 'Muted',\r\n\t\t\tid: 'muted',\r\n\t\t\tsymbol: '!',\r\n\t\t};\r\n\t}\r\n}\r\n\r\nexport function checkRipgrepAvailability() {\r\n\tif (Config.ripgrepmodlog === undefined) {\r\n\t\tconst cwd = FS.ROOT_PATH;\r\n\t\tConfig.ripgrepmodlog = (async () => {\r\n\t\t\ttry {\r\n\t\t\t\tawait ProcessManager.exec(['rg', '--version'], { cwd });\r\n\t\t\t\tawait ProcessManager.exec(['tac', '--version'], { cwd });\r\n\t\t\t\treturn true;\r\n\t\t\t} catch {\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t})();\r\n\t}\r\n\treturn Config.ripgrepmodlog;\r\n}\r\n\r\nfunction reportError(msg: string) {\r\n\t// This module generally loads before Monitor, so we put this in a setImmediate to wait for it to load.\r\n\t// Most child processes don't have Monitor.error, but the main process should always have them, and Config\r\n\t// errors should always be the same across processes, so this is a neat way to avoid unnecessary logging.\r\n\tsetImmediate(() => global.Monitor?.error?.(`[CONFIG] ${msg}`));\r\n}\r\nexport const Config = load();\r\n"],
  "mappings": "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",
  "names": []
}
